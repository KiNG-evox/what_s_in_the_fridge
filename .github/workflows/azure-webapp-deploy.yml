name: Deploy to Azure Web App via OIDC

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'whats-in-the-fridge'
  NODE_VERSION: '20.x'
  WORKING_DIR: './whats-in-the-fridge'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # Required for OIDC
      contents: read

    steps:
    # --------------------
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # --------------------
    - name: ğŸŸ¢ Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          whats-in-the-fridge/frontend/package-lock.json
          whats-in-the-fridge/backEnd/package-lock.json

    # --------------------
    # Build Frontend
    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ${{ env.WORKING_DIR }}/frontend
      run: npm ci

    - name: ğŸ”¨ Build frontend (Angular)
      working-directory: ${{ env.WORKING_DIR }}/frontend
      run: npm run build -- --configuration=production

    - name: âœ… Verify frontend build
      run: |
        if [ ! -d "${{ env.WORKING_DIR }}/frontend/dist/frontend/browser" ]; then
          echo "âŒ Frontend build failed - dist folder not found"
          exit 1
        fi
        echo "âœ… Frontend built successfully"
        ls -la ${{ env.WORKING_DIR }}/frontend/dist/frontend/browser

    # --------------------
    # Prepare Backend
    - name: ğŸ“¦ Install backend dependencies
      working-directory: ${{ env.WORKING_DIR }}/backEnd
      run: npm ci --omit=dev

    # --------------------
    # Create deployment package
    - name: ğŸ“¦ Create deployment package
      run: |
        mkdir -p deploy
        cp -r ${{ env.WORKING_DIR }}/backEnd/* deploy/
        mkdir -p deploy/frontend/dist/frontend
        cp -r ${{ env.WORKING_DIR }}/frontend/dist/frontend/browser deploy/frontend/dist/frontend/
        [ -f ${{ env.WORKING_DIR }}/backEnd/web.config ] && cp ${{ env.WORKING_DIR }}/backEnd/web.config deploy/ || echo "âš ï¸ No web.config found"
        mkdir -p deploy/uploads
        cd deploy
        zip -r ../deployment.zip . -x "*.git*" -x "*node_modules/.cache/*" -x "*.env"
        cd ..
        echo "âœ… Deployment package created"
        ls -lh deployment.zip

    # --------------------
    # Authenticate to Azure via OIDC
    - name: ğŸ” Azure Login via OIDC
      uses: azure/login@v2

    # Optional: verify login succeeded
    - name: ğŸ” Verify Azure login
      run: az account show

    # --------------------
    # Deploy to Azure
    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ./deployment.zip
        slot-name: production  # optional, remove if not using slots

    # --------------------
    # Deployment Summary
    - name: ğŸ‰ Deployment Summary
      run: |
        echo "âœ… Application deployed successfully!"
        echo "ğŸŒ Frontend URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "ğŸ”Œ API URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api"
